name: Deploy to Cloud Run

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: '1.16'

    - name: Build
      run: go build -v .

    - name: Authenticate to Google Cloud
      id: 'auth'
      uses: 'google-github-actions/auth@v0.5.3'
      with:
        workload_identity_provider: 'projects/760527922880/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
        service_account: '760527922880-compute@developer.gserviceaccount.com'

    - name: Configure gcloud CLI
      uses: google-github-actions/setup-gcloud@v0.9.1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Build and push Docker image
      run: |
        IMAGE_NAME=gcr.io/${{ secrets.GCP_PROJECT_ID }}/myapp
        docker build -t $IMAGE_NAME .
        docker push $IMAGE_NAME

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy myapp \
          --image=gcr.io/${{ secrets.GCP_PROJECT_ID }}/myapp \
          --platform=managed \
          --region=us-central1 \
          --allow-unauthenticated
